{"version":3,"sources":["../../src/common/Game.js"],"names":["BITE_WIDTH","COUNTS_TO_WIN","PLATE_BITES","PLAYER_WIDTH_BUFFER","PLAYERS_COUNT","initBites","game","controls","KeyboardControls","renderer","clientEngine","order","shuffle","bites","document","querySelector","forEach","o","button","createElement","classList","add","setAttribute","innerHTML","addEventListener","ev","querySelectorAll","length","contains","sendInput","i","children","appendChild","Math","random","b","remove","initPlayers","players","player","arr","currentIndex","randomIndex","temporaryValue","floor","Plate","gameEngine","options","props","blocked","count","other","Object","assign","type","BaseTypes","TYPES","INT16","DynamicObject","Game","physicsEngine","SimplePhysicsEngine","on","gameLogic","bind","serverSideInit","serverSidePlayerJoined","serverSidePlayerDisconnected","clientSideInit","clientSideDraw","serializer","registerClass","plates","world","queryObjects","instanceType","p","inputData","playerId","plate","queryObject","input","initValues","addObjectToWorld","joined","removeObjectFromWorld","id","window","returnValue","plateElement","style","width","join","GameEngine"],"mappings":"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","sourcesContent":["import { GameEngine, BaseTypes, DynamicObject, KeyboardControls, SimplePhysicsEngine } from 'lance-gg'\n\nconst BITE_WIDTH = 20\nconst COUNTS_TO_WIN = 10\nconst PLATE_BITES = 9\nconst PLAYER_WIDTH_BUFFER = 60\nconst PLAYERS_COUNT = 20\n\nconst initBites = game => {\n  game.controls = new KeyboardControls(game.renderer.clientEngine)\n\n  const order = [0, 1, 2, 3, 4, 5, 6, 7, 8]\n\n  shuffle(order)\n\n  const bites = document.querySelector('#bites')\n\n  order.forEach(o => {\n    const button = document.createElement('button')\n\n    button.classList.add('bite', 'button')\n\n    button.setAttribute('data-order', o)\n\n    button.innerHTML = 'bite ' + o\n\n    button.addEventListener('click', ev => {\n      if (o !== document.querySelectorAll('.bite.hidden').length) {\n        return true\n      }\n\n      if (button.classList.contains('blocked')) {\n        return true\n      }\n\n      button.classList.add('hidden')\n\n      game.controls.clientEngine.sendInput('bite')\n\n      if (o === PLATE_BITES - 1) {\n        const bites = document.querySelector('#bites')\n    \n        for (let i = bites.children.length; i >= 0; i--) {\n            bites.appendChild(bites.children[Math.random() * i | 0])\n        }\n\n        document.querySelectorAll('.bite').forEach(b => b.classList.remove('hidden'))\n      }\n    })\n\n    bites.appendChild(button)\n  })\n}\n\nconst initPlayers = game => {\n  const players = document.querySelector('#players')\n\n  for (let i = 0; i < PLAYERS_COUNT; i++) {\n    const player = document.createElement('div')\n\n    player.classList.add('player', 'hidden')\n\n    player.setAttribute('id', 'player' + i)\n\n    players.appendChild(player)\n  }\n}\n\nconst shuffle = arr => {\n  let currentIndex = arr.length\n  let randomIndex\n  let temporaryValue\n\n  // While there remain elements to shuffle...\n  while (currentIndex !== 0) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex)\n    currentIndex -= 1\n\n    // And swap it with the current element.\n    temporaryValue = arr[currentIndex]\n    arr[currentIndex] = arr[randomIndex]\n    arr[randomIndex] = temporaryValue\n  }\n\n  return arr\n}\n\n// A paddle has a health attribute\nclass Plate extends DynamicObject {\n  constructor (gameEngine, options, props) {\n    super(gameEngine, options, props)\n\n    this.bites = 0\n    this.blocked = 0\n    this.count = 0\n  }\n\n  static get netScheme () {\n    return Object.assign({\n      bites: { type: BaseTypes.TYPES.INT16 },\n      count: { type: BaseTypes.TYPES.INT16 }\n    }, super.netScheme)\n  }\n\n  syncTo (other) {\n    super.syncTo(other)\n\n    this.bites = other.bites\n    this.count = other.count\n  }\n}\n\nexport default class Game extends GameEngine {\n  constructor (options) {\n    super(options)\n    this.physicsEngine = new SimplePhysicsEngine({ gameEngine: this })\n\n    // common code\n    this.on('postStep', this.gameLogic.bind(this))\n\n    // server-only code\n    this.on('server__init', this.serverSideInit.bind(this))\n    this.on('server__playerJoined', this.serverSidePlayerJoined.bind(this))\n    this.on('server__playerDisconnected', this.serverSidePlayerDisconnected.bind(this))\n\n    // client-only code\n    this.on('client__rendererReady', this.clientSideInit.bind(this))\n    this.on('client__draw', this.clientSideDraw.bind(this))\n  }\n\n  registerClasses (serializer) {\n    serializer.registerClass(Plate)\n  }\n\n  gameLogic () {\n    const plates = this.world.queryObjects({ instanceType: Plate })\n\n    if (plates.length < 2) {\n      return\n    }\n\n    plates.forEach((p, i) => {\n      if (p.bites === PLATE_BITES) {\n        p.count++\n        p.bites = 0\n\n        if (p.count === COUNTS_TO_WIN) {\n        }\n      }\n    })\n  }\n\n  processInput (inputData, playerId) {\n    super.processInput(inputData, playerId)\n\n    // get the player paddle tied to the player socket\n    const plate = this.world.queryObject({ playerId })\n    if (plate) {\n      if (inputData.input === 'bite') {\n        plate.bites++\n      }\n    }\n  }\n\n  //\n  // SERVER ONLY CODE\n  //\n  serverSideInit () {\n    const initValues = {\n      bites: 0,\n      blocked: false,\n      count: 0,\n      playerId: 0\n    }\n\n    for (let i = 0; i < PLAYERS_COUNT; i++) {\n      this.addObjectToWorld(new Plate(this, null, initValues))\n    }\n  }\n\n  // attach newly connected player to next available paddle\n  serverSidePlayerJoined (ev) {\n    const plates = this.world.queryObjects({ instanceType: Plate })\n\n    let joined = false\n\n    plates.forEach(plate => {\n      if (joined) {\n        return\n      }\n\n      if (plate.playerId === 0) {\n        plate.playerId = ev.playerId\n\n        joined = true\n      }\n    })\n  }\n\n  serverSidePlayerDisconnected (ev) {\n    const plates = this.world.queryObjects({ instanceType: Plate })\n\n    plates.forEach(plate => {\n      if (plate.playerId !== ev.playerId) {\n        return\n      }\n      this.removeObjectFromWorld(plate.id)\n    })\n  }\n\n  //\n  // CLIENT ONLY CODE\n  //\n  clientSideInit () {\n    initBites(this)\n\n    initPlayers(this)\n\n    window.addEventListener('beforeunload', ev => {\n      ev.returnValue = 'Are you sure you want to leave the game?'\n    })\n  }\n\n  clientSideDraw () {\n    const plates = this.world.queryObjects({ instanceType: Plate })\n\n    if (!plates.length) {\n      return\n    }\n\n    plates.forEach((plate, i) => {\n      const plateElement = document.querySelector('#player' + i)\n\n      if (plateElement && plate.playerId) {\n        plateElement.classList.remove('hidden')\n        plateElement.style.width = PLAYER_WIDTH_BUFFER + ((PLATE_BITES - plate.bites) * BITE_WIDTH) + 'px'\n        plateElement.innerHTML = [plate.playerId, plate.count, plate.bites].join(' ')\n      }\n    })\n  }\n}\n"],"file":"Game.js"}